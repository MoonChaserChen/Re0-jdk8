# 线程池的实现
任务的管理是一件比较容易的事，复杂的是线程的管理，这会涉及线程数量、等待/唤醒、同步/锁、线程创建和死亡等问题。

## 从ThreadPoolExecutor说起
提到线程池，绕不开的就是ThreadPoolExecutor，这个类是线程池的其中一种实现。包括前面的[线程池处理流程](/3-线程池/3.1-线程池.md#线程池处理流程)，
说的其实也就是ThreadPoolExecutor的处理流程。实际上线程池并未规定死怎么去实现这个处理流程，ThreadPoolExecutor只是一种使用较多的实现方式而已。
线程池唯一规定只有一个执行方法，位于`Executor`类中
```java
public interface Executor {
    void execute(Runnable command);
}
```
这里要介绍的线程池实现也是：ThreadPoolExecutor

## 相关属性
ThreadPoolExecutor与线程相关的几个成员变量是：keepAliveTime、allowCoreThreadTimeOut、poolSize、corePoolSize、maximumPoolSize，
它们共同负责线程的创建和销毁。

### poolSize：
线程池中当前线程的数量，当该值为0的时候，意味着没有任何线程，线程池会终止；poolSize不会超过maximumPoolSize。

### corePoolSize：
线程池的核心线程数量，只有在工作队列满了的情况下才会创建超出这个数量的线程。这里需要注意的是：在刚刚创建ThreadPoolExecutor的时候，
线程并不会立即启动，而是要等到有任务提交时才会启动，除非调用了prestartCoreThread/prestartAllCoreThreads事先启动核心线程。
再考虑到keepAliveTime和allowCoreThreadTimeOut超时参数的影响，所以没有任务需要执行的时候，线程池的大小不一定是corePoolSize。

### BlockingQueue
任务缓存阻塞队列

### maximumPoolSize：
线程池中允许的最大线程数，线程池中的当前线程数目不会超过该值。如果队列中任务已满，并且当前线程个数小于maximumPoolSize，那么会创建新的线程来执行任务。
这里值得一提的是largestPoolSize，该变量记录了线程池在整个生命周期中曾经出现的最大线程个数。
为什么说是曾经呢？因为线程池创建之后，可以调用setMaximumPoolSize()改变运行的最大线程的数目。

### keepAliveTime：
如果一个非核心线程处在空闲状态的时间超过了该属性值，就会因为超时而退出。举个例子，如果线程池的核心大小corePoolSize=5，而当前大小poolSize =8，
那么超出核心大小的线程，会按照keepAliveTime的值判断是否会超时退出。如果线程池的核心大小corePoolSize=5，而当前大小poolSize =5，
那么线程池中所有线程都是核心线程，这个时候线程是否会退出，取决于allowCoreThreadTimeOut。

### allowCoreThreadTimeOut：
该属性用来控制是否允许核心线程超时退出,默认false。

### ThreadFactory:
线程创建工厂类，默认Executors.defaultThreadFactory()

### RejectedExecutionHandler:
超出线程池处理能力时的任务拒绝策略，默认AbortPolicy

## JDK自带实现类
用户可自行使用ThreadPoolExecutor去实现线程池，然而JDK已经自带了一些实现如下：

| 自带实现 | corePoolSize | maximumPoolSize | keepAliveTime | TimeUnit | BlockingQueue |
| ---- | ---- | ---- | ---- | ---- | ---- |
| Executors.newCachedThreadPool() | 0 | Integer.MAX_VALUE | 60 | SECONDS | SynchronousQueue |
| Executors.newFixedThreadPool() | 必选参数 | =corePoolSize | 0 | MILLISECONDS | LinkedBlockingQueue |
| Executors.newSingleThreadExecutor() | 1 | 1 | 0 | MILLISECONDS | LinkedBlockingQueue |
| Executors.newScheduledThreadPool() | 必选参数 | Integer.MAX_VALUE | 0 | NANOSECONDS | DelayedWorkQueue |
| Executors.newSingleThreadScheduledExecutor() | 1 | Integer.MAX_VALUE | 0 | NANOSECONDS | DelayedWorkQueue |

### newCachedThreadPool
核心线程数为0，最大线程数不限，非核心线程60秒超时销毁，无容量的队列。

### newFixedThreadPool
固定核心线程数，最大线程数等于核心线程数，线程不销毁，不限容量的队列。

### newCachedThreadPool与newFixedThreadPool对比


